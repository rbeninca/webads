<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Simples - Texto + Compartilhamento de Tela</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chatLog { width: 100%; height: 200px; margin-top: 10px; }
    video { width: 500px; border: 1px solid #333; margin-top: 10px; }
    textarea, input, button { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>WebRTC Simples - Texto + Compartilhamento de Tela</h2>

  <button onclick="startAsCaller()">Iniciar como Chamador</button>
  <button onclick="startAsCallee()">Iniciar como Receptor</button>

  <div>
    <h3>Trocar SDP Manualmente</h3>
    <label for="localSDP">SDP Local:</label><br>
    <textarea id="localSDP" cols="60" rows="6" readonly></textarea><br>
    <label for="remoteSDP">Cole o SDP Remoto:</label><br>
    <textarea id="remoteSDP" cols="60" rows="6"></textarea><br>
    <button onclick="setRemoteSDP()">Definir SDP Remoto</button>
  </div>

  <h3>Chat</h3>
  <textarea id="chatLog" readonly></textarea><br>
  <input type="text" id="mensagem" placeholder="Digite uma mensagem">
  <button onclick="enviarMensagem()">Enviar Mensagem</button>

  <h3>Compartilhar Tela</h3>
  <button onclick="compartilharTela()">Compartilhar Minha Tela</button>

  <h3>Tela Recebida</h3>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
let connection;
let dataChannel;
let screenStream;
let remoteStream;

async function startAsCaller() {
  connection = new RTCPeerConnection();
  remoteStream = new MediaStream();
  document.getElementById("remoteVideo").srcObject = remoteStream;

  dataChannel = connection.createDataChannel("chat");
  setupDataChannel();

  connection.onicecandidate = () => atualizarLocalSDP();

  connection.ontrack = event => {
    log("Recebendo stream de vídeo...");
    remoteStream.addTrack(event.track);
  };

  const offer = await connection.createOffer();
  await connection.setLocalDescription(offer);

  log("Offer inicial criado! Copie o SDP local e envie ao receptor.");
}

async function startAsCallee() {
  connection = new RTCPeerConnection();
  remoteStream = new MediaStream();
  document.getElementById("remoteVideo").srcObject = remoteStream;

  connection.ondatachannel = event => {
    dataChannel = event.channel;
    setupDataChannel();
  };

  connection.onicecandidate = () => atualizarLocalSDP();

  connection.ontrack = event => {
    log("Recebendo stream de vídeo...");
    remoteStream.addTrack(event.track);
  };

  log("Aguardando SDP remoto (offer) para responder com o answer.");
}

async function setRemoteSDP() {
  const remoteSDP = JSON.parse(document.getElementById("remoteSDP").value);
  await connection.setRemoteDescription(new RTCSessionDescription(remoteSDP));

  if (remoteSDP.type === "offer") {
    const answer = await connection.createAnswer();
    await connection.setLocalDescription(answer);
    await esperarIceGatheringCompleto();

    atualizarLocalSDP();

    log("Novo answer criado! Copie e envie ao chamador.");
  } else {
    log("Novo SDP remoto aplicado com sucesso.");
  }
}

function setupDataChannel() {
  dataChannel.onopen = () => log("Canal de dados aberto!");
  dataChannel.onmessage = event => log("Recebido: " + event.data);
}

function enviarMensagem() {
  const msg = document.getElementById("mensagem").value;
  if (dataChannel && dataChannel.readyState === "open") {
    dataChannel.send(msg);
    log("Você: " + msg);
    document.getElementById("mensagem").value = "";
  } else {
    alert("Canal não está aberto!");
  }
}

async function compartilharTela() {
  try {
    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });

    screenStream.getTracks().forEach(track => {
      connection.addTrack(track, screenStream);
    });

    log("Tela sendo compartilhada! Gerando novo offer...");

    const offer = await connection.createOffer();
    await connection.setLocalDescription(offer);

    await esperarIceGatheringCompleto();

    atualizarLocalSDP();

    log("Novo offer com tela criado! Copie o SDP e envie ao receptor.");

  } catch (err) {
    console.error("Erro ao compartilhar a tela:", err);
  }
}

function atualizarLocalSDP() {
  if (connection.localDescription) {
    document.getElementById("localSDP").value = JSON.stringify(connection.localDescription);
  }
}

async function esperarIceGatheringCompleto() {
  return new Promise(resolve => {
    if (connection.iceGatheringState === "complete") {
      resolve();
    } else {
      const checkState = () => {
        if (connection.iceGatheringState === "complete") {
          connection.removeEventListener('icegatheringstatechange', checkState);
          resolve();
        }
      };
      connection.addEventListener('icegatheringstatechange', checkState);
    }
  });
}

function log(msg) {
  const chatLog = document.getElementById("chatLog");
  chatLog.value += msg + "\n";
  chatLog.scrollTop = chatLog.scrollHeight;
}
</script>
</body>
</html>