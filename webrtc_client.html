<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WebRTC + Google Sheets (Token Autom√°tico)</title>
</head>
<body onload="initApp()">
  <h2>WebRTC + Google Sheets + ICE Completo + Token Autom√°tico</h2>

  <button id="loginBtn" onclick="handleAuthClick()">üîê Login com Google</button>
  <button onclick="handleSignOutClick()">üö™ Logout</button>

  <div id="servidorArea" style="display:none;">
    <h3>Servidor criado!</h3>
    <p>C√≥digo da sala: <strong id="codigoServidor"></strong></p>
    <div id="statusServidor">Aguardando cliente...</div>
  </div>

  <div id="clienteArea">
    <h3>Entrar como Cliente</h3>
    <input id="codigoCliente" placeholder="Digite o c√≥digo de 4 letras">
    <button onclick="entrarComoCliente()">Entrar</button>
    <div id="statusCliente"></div>
  </div>

  <h3>Chat</h3>
  <textarea id="chatLog" cols="50" rows="10" readonly></textarea><br>
  <input id="mensagem" placeholder="Digite sua mensagem">
  <button onclick="enviarMensagem()">Enviar</button>

  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    const CLIENT_ID = '746398410753-frgmr1vva6sncpeg1q08am6mjp0csvh5.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const sheetId = '1maMNlXrKpPKT2z1jDNXqXWGGRjeeX4LFIyUSrcoIt_o';
    const planilha = 'Sheet1';

    let connection;
    let dataChannel;
    let tokenClient;

    function initApp() {
      gapi.load('client', initializeGapiClient);
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // ser√° atribu√≠do no login
      });
    }

    async function initializeGapiClient() {
      await gapi.client.init({});
      console.log("‚úÖ GAPI Client inicializado");
    }

    async function handleAuthClick() {
      if (!tokenClient) {
        alert('O Google Identity Services n√£o foi carregado!');
        return;
      }

      tokenClient.callback = async (resp) => {
        if (resp.error) {
          console.error(resp);
          alert("Erro no login!");
          return;
        }

        const accessToken = resp.access_token;
        gapi.client.setToken({ access_token: accessToken });
        sessionStorage.setItem("oauth_token", accessToken);

        console.log('‚úÖ Token salvo:', accessToken);

        alert("‚úÖ Login realizado com sucesso!");
        iniciarComoServidorOuCliente();
      };

      tokenClient.requestAccessToken({ prompt: '' });
    }

    function handleSignOutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        sessionStorage.removeItem("oauth_token");
        alert('Deslogado com sucesso!');
      }
    }

    async function getOAuthToken() {
      let token = sessionStorage.getItem("oauth_token");

      if (!token) {
        console.warn("üîÑ Nenhum token encontrado. Solicitando novo...");
        await new Promise(resolve => {
          tokenClient.callback = async (resp) => {
            if (resp.error) {
              console.error("Erro ao renovar token:", resp);
              return;
            }
            token = resp.access_token;
            gapi.client.setToken({ access_token: token });
            sessionStorage.setItem("oauth_token", token);
            console.log("üîÑ Novo token recebido e salvo.");
            resolve();
          };
          tokenClient.requestAccessToken({ prompt: '' });
        });
      }

      return token;
    }

    async function iniciarComoServidorOuCliente() {
      const codigosExistentes = await buscarCodigosExistentes();
      if (!codigosExistentes || codigosExistentes.length === 0) {
        criarServidor();
      }
    }

    async function criarServidor() {
      connection = new RTCPeerConnection();

      connection.oniceconnectionstatechange = () => {
        console.log('Servidor ICE state:', connection.iceConnectionState);
      };

      connection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel(dataChannel, "servidor");
      };

      dataChannel = connection.createDataChannel('chat');
      setupDataChannel(dataChannel, "servidor");

      const offer = await connection.createOffer({ iceRestart: false });
      await connection.setLocalDescription(offer);

      console.log("‚è≥ Aguardando ICE gathering no servidor...");
      await esperarIceGatheringCompleto(connection);
      console.log("‚úÖ ICE gathering completo no servidor!");

      const codigo = gerarCodigoAleatorio();
      document.getElementById('codigoServidor').innerText = codigo;
      document.getElementById('servidorArea').style.display = 'block';

      await criarNovaSalaNaPlanilha(codigo, connection.localDescription);
      aguardarRespostaCliente(codigo);
    }

    async function aguardarRespostaCliente(codigo) {
      const intervalo = setInterval(async () => {
        const linha = await buscarLinhaPorCodigo(codigo);

        if (linha && linha[2]) {
          const answerSDP = JSON.parse(linha[2]);
          await connection.setRemoteDescription(new RTCSessionDescription(answerSDP));
          console.log("‚úÖ Resposta do cliente recebida!");
          clearInterval(intervalo);
        }
      }, 2000);
    }

    async function entrarComoCliente() {
      connection = new RTCPeerConnection();

      connection.oniceconnectionstatechange = () => {
        console.log('Cliente ICE state:', connection.iceConnectionState);
      };

      connection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel(dataChannel, "cliente");
      };

      const codigo = document.getElementById('codigoCliente').value.trim().toUpperCase();
      if (!codigo || codigo.length !== 4) {
        alert("Digite um c√≥digo v√°lido com 4 letras!");
        return;
      }

      const linha = await buscarLinhaPorCodigo(codigo);

      if (!linha || !linha[1]) {
        alert("C√≥digo inv√°lido ou sala n√£o encontrada.");
        return;
      }

      const offerSDP = JSON.parse(linha[1]);
      await connection.setRemoteDescription(new RTCSessionDescription(offerSDP));

      const answer = await connection.createAnswer({ iceRestart: false });
      await connection.setLocalDescription(answer);

      console.log("‚è≥ Aguardando ICE gathering no cliente...");
      await esperarIceGatheringCompleto(connection);
      console.log("‚úÖ ICE gathering completo no cliente!");

      await atualizarAnswerNaPlanilha(codigo, connection.localDescription);
    }

    function setupDataChannel(channel, tipo) {
      channel.onopen = () => {
        console.log(`üéâ Canal de dados aberto (${tipo})`);
        document.getElementById(`status${tipo === "servidor" ? "Servidor" : "Cliente"}`).innerText = `‚úÖ Conectado!`;
      };

      channel.onmessage = (event) => {
        escreverChat(`${tipo === "servidor" ? "Cliente" : "Servidor"}: ${event.data}`);
      };
    }

    async function esperarIceGatheringCompleto(pc) {
      return new Promise(resolve => {
        if (pc.iceGatheringState === 'complete') {
          resolve();
        } else {
          const checkState = () => {
            if (pc.iceGatheringState === 'complete') {
              pc.removeEventListener('icegatheringstatechange', checkState);
              resolve();
            }
          };
          pc.addEventListener('icegatheringstatechange', checkState);
        }
      });
    }

    function enviarMensagem() {
      const mensagem = document.getElementById('mensagem').value;

      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(mensagem);
        escreverChat("Voc√™: " + mensagem);
        document.getElementById('mensagem').value = '';
      } else {
        alert('‚ùå O canal ainda n√£o est√° aberto!');
      }
    }

    function escreverChat(mensagem) {
      const chatLog = document.getElementById('chatLog');
      chatLog.value += mensagem + '\n';
    }

    function gerarCodigoAleatorio() {
      const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let codigo = '';
      for (let i = 0; i < 4; i++) {
        codigo += letras.charAt(Math.floor(Math.random() * letras.length));
      }
      return codigo;
    }

    async function buscarCodigosExistentes() {
      try {
        const accessToken = await getOAuthToken();
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${planilha}!A2:A`,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`
            }
          }
        );

        if (!response.ok) throw new Error(`Erro: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        console.log('C√≥digos existentes:', data.values);
        return data.values ? data.values.flat() : [];

      } catch (error) {
        console.error('Erro ao buscar c√≥digos existentes:', error);
        return [];
      }
    }

    async function buscarLinhaPorCodigo(codigo) {
      try {
        const accessToken = await getOAuthToken();
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${planilha}!A2:C`,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`
            }
          }
        );

        if (!response.ok) throw new Error(`Erro: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        console.log('Linhas encontradas:', data.values);

        if (!data.values) return null;

        for (let linha of data.values) {
          if (linha[0].trim().toUpperCase() === codigo) {
            console.log('C√≥digo encontrado:', linha);
            return linha;
          }
        }

        return null;

      } catch (error) {
        console.error('Erro ao buscar linha:', error);
        return null;
      }
    }

    async function criarNovaSalaNaPlanilha(codigo, offerSDP) {
      try {
        const accessToken = await getOAuthToken();
        const valores = [[codigo, JSON.stringify(offerSDP), '']];
        const body = { values: valores };

        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${planilha}!A:C:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS`,
          {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
          }
        );

        if (!response.ok) throw new Error(`Erro: ${response.status} - ${await response.text()}`);
        console.log("‚úÖ Sala criada com sucesso!");

      } catch (error) {
        console.error('Erro ao criar sala:', error);
      }
    }

    async function atualizarAnswerNaPlanilha(codigo, answerSDP) {
      try {
        const accessToken = await getOAuthToken();
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${planilha}!A2:C`,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`
            }
          }
        );

        if (!response.ok) throw new Error(`Erro: ${response.status} - ${await response.text()}`);

        const data = await response.json();
        console.log('Linhas para atualiza√ß√£o:', data.values);

        if (!data.values) return;

        let linhaIndex = -1;
        for (let i = 0; i < data.values.length; i++) {
          if (data.values[i][0] === codigo) {
            linhaIndex = i;
            break;
          }
        }

        if (linhaIndex === -1) {
          console.error('C√≥digo n√£o encontrado!');
          return;
        }

        const updateResponse = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${planilha}!C${linhaIndex + 2}?valueInputOption=RAW`,
          {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              values: [[JSON.stringify(answerSDP)]]
            })
          }
        );

        if (!updateResponse.ok) throw new Error(`Erro: ${updateResponse.status} - ${await updateResponse.text()}`);
        console.log("‚úÖ Answer atualizado com sucesso!");

      } catch (error) {
        console.error('Erro ao atualizar Answer SDP:', error);
      }
    }

  </script>
</body>
</html>
